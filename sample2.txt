//-----------------------------AM added 16.10.2018

DATA MASTER_TABLES.T_SUBSCRIBER_KEYWORDS;
SET MASTER_TABLES.T_SUBSCRIBER_KEYWORDS;
COLUMN EMAIL_CC_CALL_OR_DISTR TYPE=STRING;

IF FUNDMAGIC_KEYWORD = "CALL" THEN
	IF INSTR(KEYWORDS,"CC ECALL/ROC NOTICE") > 0 AND INSTR (KEYWORDS,"MAIN CONTACT") = 0 THEN
	EMAIL_CC_CALL_OR_DISTR=EMAIL;
	ELSEIF INSTR(KEYWORDS,"CC ECALL/ROC NOTICE") = 0 AND INSTR (KEYWORDS,"MAIN CONTACT") = 0 THEN
	EMAIL_CC_CALL_OR_DISTR="";
	END;
END;

IF FUNDMAGIC_KEYWORD = "DIST" THEN	
   IF INSTR(KEYWORDS,"CC EDIST LETTER") > 0 AND INSTR (KEYWORDS,"MAIN CONTACT") = 0 THEN
   EMAIL_CC_CALL_OR_DISTR=EMAIL;
	ELSEIF INSTR(KEYWORDS,"CC EDIST LETTER") = 0 AND INSTR (KEYWORDS,"MAIN CONTACT") = 0 THEN
	EMAIL_CC_CALL_OR_DISTR="";
	END;
 END; 
 RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
SET MASTER_TABLES.T_SUBSCRIBER_KEYWORDS;
RUN;

PROC SORT DATA=MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
BY SUBSCRIBER_IQID;
RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
SET MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
COLUMN EMAIL_CC_CALL_OR_DISTR_2 TYPE=STRING;
 COLUMN LENGHT_OF_EMAILS TYPE=INTEGER;
EMAIL_CC_CALL_OR_DISTR_2=EMAIL_CC_CALL_OR_DISTR;

IF SUBSCRIBER_IQID=LAG(SUBSCRIBER_IQID) AND  EMAIL_CC_CALL_OR_DISTR<>"" THEN
		EMAIL_CC_CALL_OR_DISTR_2 = EMAIL_CC_CALL_OR_DISTR_2&"; "&LAG(EMAIL_CC_CALL_OR_DISTR_2);
		ELSEIF SUBSCRIBER_IQID=LAG(SUBSCRIBER_IQID) AND  EMAIL_CC_CALL_OR_DISTR=""  THEN
		EMAIL_CC_CALL_OR_DISTR_2 = LAG(EMAIL_CC_CALL_OR_DISTR_2);
              
 END;

LENGHT_OF_EMAILS=LEN(EMAIL_CC_CALL_OR_DISTR_2);
 
RUN;
   
PROC SORT DATA=MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
BY DESCENDING SUBSCRIBER_IQID DESCENDING LENGHT_OF_EMAILS;
RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
SET  MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
COLUMN KEEP TYPE=STRING;
COLUMN EMAIL_CC_CALL_OR_DISTR_FINAL TYPE=STRING;
EMAIL_CC_CALL_OR_DISTR_FINAL=EMAIL_CC_CALL_OR_DISTR_2;

IF SUBSCRIBER_IQID <> LAG(SUBSCRIBER_IQID) THEN
KEEP= "TRUE";
END;

IF RIGHT(EMAIL_CC_CALL_OR_DISTR_2,2)="; " THEN
EMAIL_CC_CALL_OR_DISTR_FINAL= LEFT(EMAIL_CC_CALL_OR_DISTR_2,(LENGHT_OF_EMAILS-2));
END;

RUN;
//PROC PRINT DATA=MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE; RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE (WHERE KEEP="TRUE");
SET MASTER_TABLES.T_SUBSCRIBER_KEYWORDS_CC_CONCATENATE;
RUN;
 //-----------------------------------------