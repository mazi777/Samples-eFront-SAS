//AM - start -----------------------
//TO WITHDRAW PREVIOUS DISTRIBUTION AMOUNTS/REINVESTED AMOUNTS PER INVESTOR

DATA MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE_CUT;
SET MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE (WHERE DISTRIBUTION_REPORT_INCLUDE="TRUE");
RUN;

%PARAM PREVIOUS_PERIOD_END_DATE TYPE=DATE LABEL="Input previous period end date";

DATA MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE_CUT (KEEP=FUNDOP_IQID SUBSCRIBER_IQID FUNDOP_NAME FUNDOP_GROUP FUNDOP_DATE SUBSCRIBER_NAME FUNDOP_SUBSCRIBER_AMOUNT FUNDOP_SUBSCRIBER_AMOUNT_CURR2_ FUNDOP_SUBSCRIBER_SUB_DISTRIBUTED);
SET MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE_CUT;

IF FUNDOP_DATE=%PREVIOUS_PERIOD_END_DATE THEN
OUTPUT;
END;
RUN;

PROC PRINT DATA=MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE_CUT; RUN;


DATA MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;
MERGE MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR(IN=T1) MASTER_TABLES.T_FUNDOPS_TOTALS_BY_SUBSCRIBER_PRIOR_TO_OPERATION_DATE_CUT (IN=T2);
BY SUBSCRIBER_IQID;
_OUTPUT_ = T1;
RUN;

//PROC PRINT DATA=MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR; RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;
SET MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;
COLUMN TOTAL_DISTR_REINVESTED TYPE=DOUBLE;

TOTAL_DISTR_REINVESTED=-SUBSCRIBER_SUB_DISTRIBUTED+FUNDOP_SUBSCRIBER_SUB_DISTRIBUTED;
RUN;

//PROC PRINT DATA=MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR; RUN;


PROC MEANS DATA=MASTER_TABLES.T_FUNDOPS_DISTRIBUTION_DRAWDOWN_TOTALS_BY_SUBSCRIBER OUT = MASTER_TABLES.T_WORKING_TABLE;
CLASS SUBSCRIBER_IQID;
SUM FUNDOP_TOT_DIST_DRAWD_SUBSCRIBER_SUB_CALLED (NAME=SUBSCRIBER_DRAWN_TOTAL);

RUN;

DATA MASTER_TABLES.T_NOTICE;
MERGE MASTER_TABLES.T_NOTICE(IN=T1) MASTER_TABLES.T_WORKING_TABLE (IN=T2);
BY SUBSCRIBER_IQID;
_OUTPUT_ = T1;
RUN;

//adding SUBSCRIBER_DRAWN_TOTAL to T_SUBSCRIBER_FUNDOPS_PRIOR and then calculating "Total amount invested"

DATA MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;
MERGE MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR(IN=T1) MASTER_TABLES.T_WORKING_TABLE (IN=T2);
BY SUBSCRIBER_IQID;
_OUTPUT_ = T1;
RUN;

DATA MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;
SET MASTER_TABLES.T_SUBSCRIBER_FUNDOPS_PRIOR;

COLUMN TOTAL_AMOUNT_INVESTED TYPE=DOUBLE;

TOTAL_AMOUNT_INVESTED=SUBSCRIBER_DRAWN_TOTAL-SUBSCRIBER_SUB_DISTRIBUTED;
RUN;

//AM creating tables for investors which declare to reinvest / didn't declare to reinvest

DATA MASTER_TABLES.T_NOTICE_REINV;
SET MASTER_TABLES.T_NOTICE (WHERE SUBSCRIBER_SUB_DISTRIBUTED<>"0" AND KEYWORDS_INVESTOR="01;");
RUN;

DATA MASTER_TABLES.T_NOTICE_NON_REINV;
SET MASTER_TABLES.T_NOTICE (WHERE SUBSCRIBER_SUB_DISTRIBUTED<>"0" AND KEYWORDS_INVESTOR<>"01;");
RUN;
//PROC PRINT DATA=MASTER_TABLES.T_NOTICE_NON_REINV; RUN;
//PROC PRINT DATA=MASTER_TABLES.T_NOTICE_REINV; RUN;

//AM - end --------------